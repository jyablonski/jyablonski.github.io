name: Website CI / CD Pipeline

on:
    pull_request:
    push:
        branches:
            - main
    repository_dispatch:
        types: [build]

env:
    UV_VERSION: "0.9.5"
    PYTHON_VERSION: "3.13"

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  version: ${{ env.UV_VERSION }}
                  python-version: ${{ env.PYTHON_VERSION }}
                  enable-cache: true
                  prune-cache: false

            - name: Run Tests
              run: uv run pytest

    deploy:
        runs-on: ubuntu-latest
        needs: test
        if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'repository_dispatch')

        permissions:
            id-token: write
            contents: read

        env:
            BUCKET_NAME: ${{ secrets.AWS_BUCKET }}
            IAM_ROLE: ${{ secrets.IAM_ROLE }}
            AWS_REGION: "us-east-1"

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  version: ${{ env.UV_VERSION }}
                  python-version: ${{ env.PYTHON_VERSION }}
                  enable-cache: true
                  prune-cache: false

            - name: Build static site
              run: uv run python server.py build

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ env.IAM_ROLE }}
                  role-session-name: website-deploy
                  aws-region: ${{ env.AWS_REGION }}

            - name: Deploy to S3
              run: aws s3 sync docs/ s3://${{ secrets.AWS_BUCKET }}/
